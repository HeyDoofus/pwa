<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duck Collector - AR Loyalty Program</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="Collect virtual ducks with AR and earn loyalty rewards">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkR1Y2sgQ29sbGVjdG9yIC0gQVIgTG95YWx0eSBQcm9ncmFtIiwKICAic2hvcnRfbmFtZSI6ICJEdWNrQ29sbGVjdG9yIiwKICAiZGVzY3JpcHRpb24iOiAiQ29sbGVjdCB2aXJ0dWFsIGR1Y2tzIHdpdGggQVIgYW5kIGVhcm4gbG95YWx0eSByZXdhcmRzIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjMjU2M2ViIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTlRFeElpQm9aV2xuYUhROUlqVXhNU0lnZG1sbGQwSnZlRDBpTUNBd0lEVXhNU0ExTVRFaUlIaHRiRzV6UFNKb2RIUndPaTh2ZDNkM0xuY3pMbTl5Wnk4eU1EQXdMM04yWnlJK1BIQmhkR2dnWkQwaU16azRJREU1TnlBeE1Ua3VOVGtnTVRnM0xqazNNekE0SURFNExqZzNNek14TGpNeU5DQXlNVGd1TURJM0lEQXVOelE0SURJeU5pNUJNelV6TGpNeklEa3pMamcxTnlBeU5qZ3VOUzQ1TURJdE1USXVOVGsxTGprNU5TMHlOaTQxTVMwMkxqWTNNelF1TXpFeUxURXVNamd0TVM0eE9EQXRNaTQxTkMweU16QXVNalE0TFRrMUxqRXpOeTB4TnpjdE1UazNMamM1TlMweU1qa3VNelUyTFRJeU9TNDBOREF0TWpVMUxqSTBNeTB4TnpZdU56VTRMVGczTGpjNE5DMHhPVGN1TnprMUxUazRMamMwTVMweU5Ua3VNekEwTFM1M09EY3RNMk11TmpjMExURXdMakUxT0MwME1pNHhNemsySWk4K1BIQmhkR2dnWm1sc2JEMGlJek5tTmpJM1ptWWlJR1E5SWsweU5qZ3VOZFV5TmpodE1qVXlMalUxT0dNMk1TNDVORFlzTUM0d056RTNPRGdzTFRRM0xqSXhPUzQ1TXpRdE1qQXVNall5TFRNMUxqQXhPUzAzT1M0NU1EQXRPVEZqTFRRMExqZzFMUzR3TkRjek5qTXRPVEV1TURFM0xqQTBOek0yTkMweE1qVXVNREkzTFM0d01EY3pPRFl0TVRZNUxqVXROUzQ0TnprdE5EZ3VNemxzTFRrMExqRXlNaTB6TlM0d01Ea3RNelV1TmpZMUxUZzFMakEzUXpNeU5TNHlPU3MwTXk0ME5EWTNOVEE1TGpjNE1pczNNUzQ1TkRZdE15NDJPRE00Tnk0ek5qZ3RPREZqTWpVdU9ERXVNRGd5TkRJdE16STBMakEzTnpFdE1UVXVOVGh0TFRJMUxqVTFPR010TXpNdU5EUTNPUzQzTnpNNU5EY3RNemc0TGpJeUxqQTFOVE1pTHo0OEwzTjJaejQ9IiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    
    <!-- AR.js and A-Frame with fallback -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js" onerror="console.error('A-Frame failed to load')"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.min.js" onerror="console.error('AR.js failed to load')"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .points {
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .duck-collection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .duck-slot {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            border: 2px dashed rgba(255,255,255,0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .duck-slot.collected {
            background: rgba(255,255,255,0.3);
            border: 2px solid rgba(255,255,255,0.6);
            transform: scale(1.05);
        }

        .duck-slot.new {
            animation: bounce 0.6s ease-in-out;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-10px); }
        }

        .ar-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
            transition: transform 0.2s;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .ar-button:hover {
            transform: translateY(-2px);
        }

        .ar-button:disabled {
            background: rgba(255,255,255,0.3);
            cursor: not-allowed;
            transform: none;
        }

        #arScene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: none;
        }

        .ar-overlay {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 1001;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            color: white;
            text-align: center;
        }

        .close-ar {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1002;
            background: rgba(255,0,0,0.8);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2em;
            cursor: pointer;
        }

        .duck-info {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            transition: width 0.3s ease;
        }

        .reward-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 2000;
            display: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .install-prompt {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .install-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 1.5em;">
        <div style="text-align: center;">
            <div style="font-size: 3em; margin-bottom: 20px;">ü¶Ü</div>
            <div>Loading Duck Collector...</div>
        </div>
    </div>

    <div class="container" id="mainApp"></div>
        <div class="header">
            <h1>ü¶Ü Duck Collector</h1>
            <p>Collect AR ducks & earn rewards!</p>
        </div>

        <div class="install-prompt" id="installPrompt" style="display: none;">
            <p>üì± Install this app for the best experience!</p>
            <button class="install-button" id="installButton">Install App</button>
        </div>

        <div class="points">
            <h2>Loyalty Points: <span id="pointsCount">0</span></h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <p>Next reward at 100 points</p>
        </div>

        <div class="duck-collection" id="duckCollection">
            <!-- Duck slots will be generated here -->
        </div>

        <button class="ar-button" id="startAR">üîç Hunt for Ducks with AR</button>
        
        <div class="duck-info">
            <h3>Duck Types</h3>
            <p>ü¶Ü Common Duck (10 pts) ‚Ä¢ üåü Golden Duck (50 pts) ‚Ä¢ üíé Diamond Duck (100 pts)</p>
            <p>Find ducks by scanning your environment with AR!</p>
        </div>
    </div>

    <!-- AR Scene -->
    <a-scene
        id="arScene"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: true; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true;"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000;">
        
        <!-- AR Camera -->
        <a-camera
            id="arCamera"
            arjs-camera="sourceType: webcam; sourceWidth: 480; sourceHeight: 360; displayWidth: 480; displayHeight: 360;"
            look-controls="enabled: false"
            wasd-controls="enabled: false"
            position="0 0 0">
        </a-camera>

        <!-- Duck models -->
        <a-entity
            id="duck1"
            position="0 0 -2"
            scale="0.5 0.5 0.5"
            rotation="0 45 0"
            visible="false"
            animation="property: rotation; to: 0 405 0; loop: true; dur: 3000">
            <a-box color="#ffeb3b" width="1" height="0.6" depth="1.5"></a-box>
            <a-sphere color="#ff9800" radius="0.4" position="0.6 0.2 0.3"></a-sphere>
            <a-cone color="#ff5722" radius-bottom="0.1" radius-top="0.05" height="0.2" position="0.8 0.1 0.4" rotation="90 0 0"></a-cone>
        </a-entity>

        <!-- Lighting -->
        <a-light type="ambient" color="#404040"></a-light>
        <a-light type="point" position="0 2 0" color="#ffffff"></a-light>
    </a-scene>

    <div class="ar-overlay" id="arOverlay" style="display: none;">
        <p>Move your camera around to find hidden ducks! Tap when you see one.</p>
        <p id="arInstructions">Looking for ducks...</p>
    </div>

    <button class="close-ar" id="closeAR" style="display: none;">√ó</button>

    <div class="reward-popup" id="rewardPopup">
        <h2>üéâ Reward Earned!</h2>
        <p id="rewardText"></p>
        <button onclick="closeRewardPopup()" class="ar-button">Awesome!</button>
    </div>

    <script>
        // App state
        let ducks = JSON.parse(localStorage.getItem('collectedDucks') || '[]');
        let points = parseInt(localStorage.getItem('loyaltyPoints') || '0');
        let isARActive = false;
        let duckSpawnTimer;
        let installPrompt;

        // Duck types
        const duckTypes = [
            { emoji: 'ü¶Ü', name: 'Common Duck', points: 10, rarity: 0.6 },
            { emoji: 'üåü', name: 'Golden Duck', points: 50, rarity: 0.3 },
            { emoji: 'üíé', name: 'Diamond Duck', points: 100, rarity: 0.1 }
        ];

        // Initialize app
        function init() {
            console.log('Initializing app...');
            
            // Show loading indicator
            document.body.style.opacity = '0';
            setTimeout(() => {
                document.body.style.transition = 'opacity 0.5s';
                document.body.style.opacity = '1';
            }, 100);
            
            updatePointsDisplay();
            renderDuckCollection();
            setupPWA();
            
            // Check if AR libraries loaded
            if (typeof AFRAME !== 'undefined') {
                console.log('AR libraries loaded, setting up AR...');
                setupAR();
            } else {
                console.warn('AR libraries not loaded, disabling AR features');
                document.getElementById('startAR').textContent = 'üì± AR Not Available (Libraries Failed)';
                document.getElementById('startAR').disabled = true;
            }
            
            // Simulate duck spawning for demo
            setTimeout(() => {
                if (ducks.length < 3) {
                    spawnDemoDuck();
                }
            }, 2000);
            
            console.log('App initialization complete');
            
            // Hide loading screen
            setTimeout(() => {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                    }, 500);
                }
            }, 1000);
        }

        function updatePointsDisplay() {
            document.getElementById('pointsCount').textContent = points;
            const progress = (points % 100) / 100 * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // Check for rewards
            if (points >= 100 && points % 100 === 0) {
                showReward();
            }
        }

        function renderDuckCollection() {
            const container = document.getElementById('duckCollection');
            container.innerHTML = '';
            
            // Show collected ducks
            for (let i = 0; i < Math.max(12, ducks.length); i++) {
                const slot = document.createElement('div');
                slot.className = 'duck-slot';
                
                if (i < ducks.length) {
                    const duck = ducks[i];
                    slot.textContent = duck.emoji;
                    slot.className += ' collected';
                    slot.title = `${duck.name} - ${duck.points} points`;
                    
                    if (duck.isNew) {
                        slot.className += ' new';
                        duck.isNew = false;
                    }
                } else {
                    slot.textContent = '?';
                    slot.title = 'Undiscovered duck';
                }
                
                container.appendChild(slot);
            }
            
            saveDucks();
        }

        function spawnDemoDuck() {
            // Simulate finding a duck without AR for demo purposes
            const randomType = Math.random() < 0.7 ? duckTypes[0] : 
                              Math.random() < 0.9 ? duckTypes[1] : duckTypes[2];
            
            collectDuck(randomType);
        }

        function collectDuck(duckType) {
            const newDuck = {
                ...duckType,
                id: Date.now(),
                timestamp: new Date(),
                isNew: true
            };
            
            ducks.push(newDuck);
            points += duckType.points;
            
            updatePointsDisplay();
            renderDuckCollection();
            
            // Show collection animation
            setTimeout(() => {
                alert(`üéâ You collected a ${duckType.name}! +${duckType.points} points`);
            }, 100);
        }

        function setupAR() {
            const startARButton = document.getElementById('startAR');
            const arScene = document.getElementById('arScene');
            const arOverlay = document.getElementById('arOverlay');
            const closeAR = document.getElementById('closeAR');
            const mainApp = document.getElementById('mainApp');

            startARButton.addEventListener('click', async () => {
                try {
                    // Request camera permission first
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 480 },
                            height: { ideal: 360 }
                        } 
                    });
                    
                    // Stop the stream immediately as AR.js will handle it
                    stream.getTracks().forEach(track => track.stop());
                    
                    isARActive = true;
                    arScene.style.display = 'block';
                    arOverlay.style.display = 'block';
                    closeAR.style.display = 'block';
                    mainApp.style.display = 'none';
                    
                    // Wait for AR scene to initialize
                    setTimeout(() => {
                        startDuckHunt();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Camera error:', error);
                    alert('Camera access is required for AR features. Please allow camera access and try again.');
                }
            });

            closeAR.addEventListener('click', () => {
                stopAR();
            });

            // Touch/click detection for AR
            arScene.addEventListener('click', (event) => {
                if (isARActive) {
                    const randomChance = Math.random();
                    if (randomChance < 0.3) { // 30% chance to find a duck
                        const duckType = getDuckByRarity();
                        collectDuck(duckType);
                        
                        // Visual feedback
                        document.getElementById('arInstructions').textContent = 
                            `Found a ${duckType.name}! Keep looking for more...`;
                        
                        setTimeout(() => {
                            if (isARActive) {
                                document.getElementById('arInstructions').textContent = 
                                    'Looking for ducks...';
                            }
                        }, 2000);
                    }
                }
            });
        }

        function startDuckHunt() {
            document.getElementById('arInstructions').textContent = 'Looking for ducks...';
            
            // Simulate duck appearances
            duckSpawnTimer = setInterval(() => {
                if (isARActive && Math.random() < 0.2) {
                    document.getElementById('arInstructions').textContent = 
                        'ü¶Ü Duck spotted! Tap the screen!';
                    
                    setTimeout(() => {
                        if (isARActive) {
                            document.getElementById('arInstructions').textContent = 
                                'Looking for ducks...';
                        }
                    }, 3000);
                }
            }, 5000);
        }

        function stopAR() {
            isARActive = false;
            clearInterval(duckSpawnTimer);
            
            // Stop all camera streams
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    stream.getTracks().forEach(track => track.stop());
                })
                .catch(() => {});
            
            document.getElementById('arScene').style.display = 'none';
            document.getElementById('arOverlay').style.display = 'none';
            document.getElementById('closeAR').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }

        function getDuckByRarity() {
            const rand = Math.random();
            let cumulative = 0;
            
            for (const duck of duckTypes) {
                cumulative += duck.rarity;
                if (rand <= cumulative) {
                    return duck;
                }
            }
            
            return duckTypes[0]; // fallback
        }

        function showReward() {
            const rewards = [
                'Free Coffee!',
                '20% Off Next Purchase',
                'Free Dessert!',
                'Double Points Next Visit',
                'VIP Access for a Day'
            ];
            
            const randomReward = rewards[Math.floor(Math.random() * rewards.length)];
            document.getElementById('rewardText').textContent = 
                `You've earned: ${randomReward}`;
            document.getElementById('rewardPopup').style.display = 'block';
        }

        function closeRewardPopup() {
            document.getElementById('rewardPopup').style.display = 'none';
        }

        function setupPWA() {
            // Service Worker registration
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'duck-collector-v1';
                    const urlsToCache = ['/'];
                    
                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then((cache) => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request)
                                .then((response) => response || fetch(event.request))
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(() => console.log('SW registered'))
                    .catch(() => console.log('SW registration failed'));
            }

            // Install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                installPrompt = e;
                document.getElementById('installPrompt').style.display = 'block';
            });

            document.getElementById('installButton').addEventListener('click', () => {
                if (installPrompt) {
                    installPrompt.prompt();
                    installPrompt.userChoice.then((choiceResult) => {
                        installPrompt = null;
                        document.getElementById('installPrompt').style.display = 'none';
                    });
                }
            });
        }

        function saveDucks() {
            localStorage.setItem('collectedDucks', JSON.stringify(ducks));
            localStorage.setItem('loyaltyPoints', points.toString());
        }

        // Error handling and debugging
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            document.body.innerHTML += `<div style="position:fixed;top:0;left:0;background:red;color:white;padding:10px;z-index:9999;">Error: ${e.message}</div>`;
        });

        // Initialize app when loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            try {
                init();
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Init error:', error);
                document.body.innerHTML = `<div style="padding:20px;color:white;background:#333;">
                    <h1>Debug Info</h1>
                    <p>Error: ${error.message}</p>
                    <p>User Agent: ${navigator.userAgent}</p>
                    <p>Location: ${window.location.href}</p>
                </div>`;
            }
        });
    </script>
</body>
</html>